# Heat Map Data Flow & Logic

## ?? Complete Data Flow Diagram

```
???????????????????????????????????????????????????????????????????
?                        DATABASE LAYER                            ?
???????????????????????????????????????????????????????????????????
                                ?
???????????????????????????????????????????????????????????????????
?  sp_GetRaionVotingStatsForHeatMap                               ?
?  - Filters regions with at least 1 vote (HAVING clause)         ?
?  - Returns: RegionId, Name, NameRu, TotalVoters, LastUpdated    ?
?  ? EXCLUDES: Transnistria regions (0 votes)                    ?
???????????????????????????????????????????????????????????????????
                                ?
???????????????????????????????????????????????????????????????????
?  StatisticsRepository.GetAllRegionsStatisticsAsync()            ?
?  - Maps SP result to RegionVotingStatistic model                ?
???????????????????????????????????????????????????????????????????
                                ?
???????????????????????????????????????????????????????????????????
?  StatisticsController.HeatMap()                                 ?
?  - Gets data from repository                                    ?
?  - Maps RegionId ? MapId (MD-AN, MD-BS, etc.)                   ?
?  - Filters regions without valid MapId                          ?
?  - Serializes to JSON ? ViewBag.MapData                         ?
???????????????????????????????????????????????????????????????????
                                ?
???????????????????????????????????????????????????????????????????
?  HeatMap.cshtml                                                 ?
?  - Renders map container                                        ?
?  - Passes ViewBag.MapData ? window.mapData                      ?
???????????????????????????????????????????????????????????????????
                                ?
???????????????????????????????????????????????????????????????????
?  statistics-heatmap.js                                          ?
?  1. Loads GeoJSON (all Moldova regions including Transnistria)  ?
?  2. Creates lookup: MapId ? Region Data                         ?
?  3. For each GeoJSON polygon:                                   ?
?     - If MapId in window.mapData ? COLOR BLUE                   ?
?     - If MapId NOT in window.mapData ? COLOR WHITE              ?
?  4. Makes only blue regions interactive                         ?
???????????????????????????????????????????????????????????????????
                                ?
???????????????????????????????????????????????????????????????????
?                        USER SEES MAP                             ?
?  ?? = Regions with votes (in database)                          ?
?  ? = Regions without votes (not in database) ? TRANSNISTRIA    ?
???????????????????????????????????????????????????????????????????
```

---

## ?? Why Transnistria Is White - Detailed Explanation

### Level 1: Database Filtering
**Location:** `sp_GetRaionVotingStatsForHeatMap`

```sql
HAVING SUM(CASE WHEN avs.AssignedVoterStatus >= 5000 THEN 1 ELSE 0 END) > 0
```

**What it does:**
- Counts voters with status >= 5000 (voted)
- Only includes regions where this count > 0
- **Transnistria regions have 0 voters** ? Excluded from result

**Result:** SP returns 32 regions (example), NO Transnistria

---

### Level 2: Controller Mapping
**Location:** `StatisticsController.HeatMap()`

```csharp
var mapData = stats.Select(r => new {
    MapId = RegionMapIdMapper.GetMapId(r.RegionId, r.Name),
    // ...
})
.Where(r => !string.IsNullOrEmpty(r.MapId))
```

**What it does:**
- Maps each region from database to a GeoJSON ID (MapId)
- Filters out regions without valid MapId
- Serializes to JSON

**Result:** Only 32 regions passed to JavaScript (no Transnistria)

---

### Level 3: JavaScript Rendering
**Location:** `statistics-heatmap.js`

```javascript
// Build lookup from database regions
const dataByMapId = {};
data.forEach(d => {
    if (d.MapId) {
        dataByMapId[d.MapId] = d; // Only 32 regions
    }
});

// For EVERY polygon in GeoJSON (including Transnistria)
var polygonData = geoFeatures.map(f => {
    const mapId = f.id;
    const info = dataByMapId[mapId]; // Lookup
    
    const hasData = !!info; // TRUE only if region is in database
    const fillColor = hasData ? COLOR_VOTED : COLOR_NO_DATA;
    
    return {
        fill: fillColor, // BLUE or WHITE
        interactive: hasData // Only blue regions clickable
    };
});
```

**What it does:**
- GeoJSON has ALL Moldova regions (35+ including Transnistria)
- Looks up each polygon's MapId in database data
- **Transnistria MapId not in database** ? `hasData = false`
- `hasData = false` ? `fillColor = COLOR_NO_DATA` (white)

**Result:** Transnistria polygons colored white, not interactive

---

## ?? Color Decision Logic

### For Each Region on Map:

```
START
  ?
Is region in database result? (sp_GetRaionVotingStatsForHeatMap)
  ?
  ?? YES ? Has MapId in RegionMapIdMapper?
  ?         ?
  ?         ?? YES ? ?? COLOR BLUE + Interactive + Show voter count
  ?         ?
  ?         ?? NO ? ? COLOR WHITE + Not interactive
  ?
  ?? NO ? ? COLOR WHITE + Not interactive + "(Nu au votat)"
         ?
         ?? THIS IS TRANSNISTRIA
```

---

## ?? Example Data Flow

### Database Result (sp_GetRaionVotingStatsForHeatMap):
```sql
RegionId | Name       | TotalVoters
---------|------------|------------
101      | Chi?in?u   | 45678
102      | B?l?i      | 23456
103      | Cahul      | 12345
-- NO Tiraspol, NO Rîbni?a (Transnistria)
```

### Controller Output (ViewBag.MapData):
```json
[
  { "MapId": "MD-CU", "RegionName": "Chi?in?u", "TotalVoters": 45678 },
  { "MapId": "MD-BS", "RegionName": "B?l?i", "TotalVoters": 23456 },
  { "MapId": "MD-CA", "RegionName": "Cahul", "TotalVoters": 12345 }
]
```

### GeoJSON Contains (moldovaHigh.json):
```javascript
features: [
  { id: "MD-CU", properties: { name: "Chi?in?u" } },  // ? In database
  { id: "MD-BS", properties: { name: "B?l?i" } },     // ? In database
  { id: "MD-CA", properties: { name: "Cahul" } },     // ? In database
  { id: "MD-TI", properties: { name: "Tiraspol" } },  // ? NOT in database
  { id: "MD-RB", properties: { name: "Rîbni?a" } }    // ? NOT in database
]
```

### JavaScript Processing:
```javascript
// MD-CU (Chi?in?u)
dataByMapId["MD-CU"] exists ? hasData = true ? COLOR BLUE

// MD-TI (Tiraspol - Transnistria)
dataByMapId["MD-TI"] DOES NOT EXIST ? hasData = false ? COLOR WHITE
```

### Visual Result:
```
Chi?in?u ? ?? Blue (45,678 voters)
B?l?i    ? ?? Blue (23,456 voters)
Cahul    ? ?? Blue (12,345 voters)
Tiraspol ? ? White (Nu au votat)
Rîbni?a  ? ? White (Nu au votat)
```

---

## ?? Key Files & Their Roles

| File | Purpose | Transnistria Handling |
|------|---------|----------------------|
| `CreateStoredProcedures.sql` | Defines SP with HAVING filter | Filters out regions with 0 votes |
| `RegionVotingStatistic.cs` | Model for SP result | Only receives regions from SP |
| `StatisticsController.cs` | Maps DB ? JSON | Only passes regions from SP |
| `RegionMapIdMapper.cs` | Maps region names ? MapId | Transnistria names NOT in dictionary |
| `statistics-heatmap.js` | Renders map colors | Colors only regions in JSON blue |

---

## ? Verification Commands

### Check Database:
```sql
-- Should NOT return Transnistria
EXEC sp_GetRaionVotingStatsForHeatMap;

-- Verify Transnistria has 0 votes
SELECT r.Name, COUNT(*) AS VoterCount
FROM AssignedVoterStatistics avs
JOIN Region r ON r.RegionId = avs.RegionId
WHERE r.Name LIKE '%Tiraspol%' OR r.Name LIKE '%Rîbni?a%'
GROUP BY r.Name;
```

### Check API:
```
GET /Statistics/DebugMapData
```

### Check Browser Console:
```javascript
// Check data passed to map
console.log(window.mapData);
console.log("Transnistria in data?", window.mapData.some(r => 
    r.RegionName.includes("Tiraspol") || r.RegionName.includes("Rîbni?a")
)); // Should be FALSE
```

---

## ?? Summary

**Question:** Why is Transnistria white on the map?

**Answer:** Because it follows this chain:

1. **Database has 0 votes** for Transnistria
2. **Stored procedure filters it out** (HAVING clause)
3. **Controller never receives it** (not in SP result)
4. **JavaScript never finds it** in the data lookup
5. **Map colors it white** by default (no data = white)

**It's automatic!** You don't need special code to exclude Transnistria - it's excluded by the voting data itself.

**The system is designed correctly:** Regions that didn't vote are automatically white, regardless of their political status.
