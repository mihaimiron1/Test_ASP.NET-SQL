@{
    ViewData["Title"] = "Heat Map - Statistici Regionale";
    var mapData = ViewBag.MapData as string ?? "[]";
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
    .card-hover {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 40;
    }

        .modal-backdrop.show {
            display: block;
        }

    .modal-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
    }

        .modal-container.show {
            display: flex;
        }

    #mapContainer {
        position: relative;
    }
</style>

<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2 flex items-center">
            <i class="fas fa-map-marked-alt text-blue-600 mr-3"></i>
            Hartă Statistici Regionale
        </h1>
        <p class="text-gray-600">Click pe o regiune pentru a vedea detalii</p>
    </div>

    <!-- Statistics Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow-md border-l-4 border-blue-500 p-6 card-hover">
            <h6 class="text-gray-600 text-sm mb-2">Total Regiuni</h6>
            <h2 class="text-3xl font-bold text-blue-600" id="totalRegions">-</h2>
        </div>
        <div class="bg-white rounded-lg shadow-md border-l-4 border-green-500 p-6 card-hover">
            <h6 class="text-gray-600 text-sm mb-2">Total Alegători</h6>
            <h2 class="text-3xl font-bold text-green-600" id="totalVoters">-</h2>
        </div>
        <div class="bg-white rounded-lg shadow-md border-l-4 border-cyan-500 p-6 card-hover">
            <h6 class="text-gray-600 text-sm mb-2">Regiuni Afișate</h6>
            <h2 class="text-3xl font-bold text-cyan-600" id="mappedRegions">-</h2>
        </div>
        <div class="bg-white rounded-lg shadow-md border-l-4 border-amber-500 p-6 card-hover">
            <h6 class="text-gray-600 text-sm mb-2">Ultima Actualizare</h6>
            <p class="text-lg font-semibold text-gray-800" id="lastUpdate">-</p>
        </div>
    </div>

    <!-- Map Container -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="bg-blue-600 text-white px-6 py-4">
            <h5 class="text-xl font-bold flex items-center">
                <i class="fas fa-map mr-2"></i>
                Harta Republicii Moldova
            </h5>
        </div>
        <div class="p-0">
            <div id="mapContainer" style="height: 700px; width: 100%;">
                <div id="mapLoading" class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-gray-600">Se încarcă harta...</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-6 py-3 text-gray-600 text-sm">
            <i class="fas fa-info-circle mr-2"></i>
            Regiunile colorate conțin date din baza de date. Regiunile albe nu au date disponibile.
        </div>
    </div>
</div>

<!-- Modal Backdrop -->
<div id="modalBackdrop" class="modal-backdrop"></div>

<!-- Region Details Modal -->
<div id="regionModal" class="modal-container">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden">
        <div class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
            <h5 class="text-xl font-bold flex items-center">
                <i class="fas fa-chart-bar mr-2"></i>
                <span id="modalRegionName">Detalii Regiune</span>
            </h5>
            <button onclick="closeModal()" class="text-white hover:text-gray-200 focus:outline-none">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
            <div id="modalContent">
                <div class="flex justify-center items-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 border-t">
            <button onclick="closeModal()" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition">
                Închide
            </button>
            <a href="#" id="viewDetailsBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition flex items-center">
                <i class="fas fa-external-link-alt mr-2"></i>
                Vezi Toate Detaliile
            </a>
        </div>
    </div>
</div>

<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/exporting.js"></script>
<script src="https://code.highcharts.com/maps/modules/offline-exporting.js"></script>
<!-- Load the am5 GeoJSON data first -->
<script src="~/js/geojson/moldovaHigh.js"></script>
<!-- Then load the wrapper that creates moldovaHigh variable -->
<script src="~/js/moldovaHigh.js"></script>

<script>
    const mapData = @Html.Raw(mapData);
    console.log('Map data loaded:', mapData.length, 'regions');

    const totalRegions = mapData.length;
    const totalVoters = mapData.reduce((sum, r) => sum + r.TotalVoters, 0);
    const lastUpdate = mapData.length > 0
        ? new Date(mapData[0].LastUpdated).toLocaleString('ro-RO')
        : 'N/A';

    document.getElementById('totalRegions').textContent = totalRegions;
    document.getElementById('totalVoters').textContent = totalVoters.toLocaleString('ro-RO');
    document.getElementById('mappedRegions').textContent = totalRegions;
    document.getElementById('lastUpdate').textContent = lastUpdate;

    const chartData = mapData.map(region => ({
        'hc-key': region.MapId.toLowerCase(),
        value: region.TotalVoters,
        regionId: region.RegionId,
        regionName: region.RegionName,
        regionNameRu: region.RegionNameRu,
        totalVoters: region.TotalVoters,
        lastUpdated: region.LastUpdated
    }));

    console.log('Chart data prepared:', chartData);

    function initializeMap() {
        if (typeof Highcharts === 'undefined') {
            document.getElementById('mapLoading').innerHTML = `
                <div class="text-center text-red-600">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p>❌ Highcharts nu s-a încărcat</p>
                </div>
            `;
            return;
        }

        if (typeof moldovaHigh === 'undefined') {
            document.getElementById('mapLoading').innerHTML = `
                <div class="text-center text-red-600">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p>❌ moldovaHigh.js nu s-a încărcat</p>
                    <p class="text-sm">Verificați dacă fișierul există</p>
                </div>
            `;
            return;
        }

        try {
            console.log('✅ Initializing map with', moldovaHigh.features.length, 'features');
            document.getElementById('mapLoading').style.display = 'none';

            Highcharts.mapChart('mapContainer', {
                chart: {
                    map: moldovaHigh,
                    backgroundColor: '#f8f9fa'
                },
                title: {
                    text: 'Statistici Regionale - Republica Moldova',
                    style: {
                        fontSize: '20px',
                        fontWeight: 'bold'
                    }
                },
                subtitle: {
                    text: 'Click pe o regiune pentru a vedea detalii'
                },
                mapNavigation: {
                    enabled: true,
                    buttonOptions: {
                        verticalAlign: 'bottom'
                    }
                },
                colorAxis: {
                    min: 0,
                    minColor: '#E0F2FE',
                    maxColor: '#0369A1',
                    labels: {
                        format: '{value:,.0f}'
                    }
                },
                legend: {
                    title: {
                        text: 'Număr Alegători',
                        style: {
                            fontWeight: 'bold'
                        }
                    },
                    align: 'left',
                    verticalAlign: 'bottom',
                    floating: true,
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    borderColor: '#CCC',
                    borderWidth: 1,
                    shadow: true
                },
                tooltip: {
                    useHTML: true,
                    formatter: function() {
                        if (!this.point.regionName) {
                            return '<b>' + this.point.name + '</b><br/>Fără date disponibile';
                        }
                        return `
                            <div style="padding: 10px;">
                                <b style="font-size: 14px;">${this.point.regionName}</b><br/>
                                <span style="color: #666;">${this.point.regionNameRu}</span><br/>
                                <hr style="margin: 5px 0;"/>
                                <b>Alegători:</b> ${this.point.totalVoters.toLocaleString('ro-RO')}<br/>
                                <small style="color: #999;">Click pentru detalii</small>
                            </div>
                        `;
                    }
                },
                series: [{
                    name: 'Alegători',
                    data: chartData,
                    states: {
                        hover: {
                            color: '#EF4444',
                            borderColor: '#991B1B'
                        }
                    },
                    dataLabels: {
                        enabled: false,
                        format: '{point.name}'
                    },
                    point: {
                        events: {
                            click: function() {
                                if (this.regionId) {
                                    showRegionDetails(this.regionId, this.regionName);
                                } else {
                                    alert('Această regiune nu are date disponibile.');
                                }
                            }
                        }
                    }
                }],
                credits: {
                    enabled: false
                }
            });

            console.log('✅ Map initialized successfully!');
        } catch (error) {
            document.getElementById('mapLoading').innerHTML = `
                <div class="text-center text-red-600">
                    <i class="fas fa-times-circle text-4xl mb-4"></i>
                    <p>❌ Eroare la inițializarea hărții</p>
                    <p class="text-sm">${error.message}</p>
                </div>
            `;
            console.error('Map initialization error:', error);
        }
    }

    setTimeout(initializeMap, 500);

    function showModal() {
        document.getElementById('modalBackdrop').classList.add('show');
        document.getElementById('regionModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('modalBackdrop').classList.remove('show');
        document.getElementById('regionModal').classList.remove('show');
        document.body.style.overflow = '';
    }

    document.getElementById('modalBackdrop').addEventListener('click', closeModal);

    function showRegionDetails(regionId, regionName) {
        document.getElementById('modalRegionName').textContent = regionName;
        document.getElementById('viewDetailsBtn').href = `/Statistics/RegionDetails/${regionId}`;
        showModal();

        fetch(`/Statistics/GetRegionStatisticsForHeatMap?regionId=${regionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderRegionDetails(data);
                } else {
                    document.getElementById('modalContent').innerHTML = `
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <div class="flex">
                                <i class="fas fa-exclamation-triangle text-yellow-400 mr-3"></i>
                                <p class="text-yellow-800">${data.message || 'Nu s-au putut încărca datele.'}</p>
                            </div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error loading region details:', error);
                document.getElementById('modalContent').innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4">
                        <div class="flex">
                            <i class="fas fa-times-circle text-red-400 mr-3"></i>
                            <p class="text-red-800">Eroare la încărcarea datelor.</p>
                        </div>
                    </div>
                `;
            });
    }

    function renderRegionDetails(data) {
        const genderHtml = data.genderStats.map(g => `
            <div class="bg-white rounded-lg shadow border-l-4 p-4" style="border-color: ${g.color};">
                <h6 class="text-gray-600 text-sm mb-1">${g.gender}</h6>
                <h3 class="text-2xl font-bold">${g.votedCount.toLocaleString('ro-RO')}</h3>
                <p class="text-sm text-gray-500">
                    ${g.percentage.toFixed(2)}% din ${g.voterCount.toLocaleString('ro-RO')}
                </p>
            </div>
        `).join('');

        const ageHtml = data.ageStats.map(a => `
            <tr class="hover:bg-gray-50">
                <td class="px-4 py-3">
                    <span class="inline-block px-3 py-1 rounded-full text-white text-sm font-semibold" style="background-color: ${a.color};">
                        ${a.ageCategoryName}
                    </span>
                </td>
                <td class="px-4 py-3 text-right">${a.voterCount.toLocaleString('ro-RO')}</td>
                <td class="px-4 py-3">
                    <div class="w-full bg-gray-200 rounded-full h-5">
                        <div class="h-5 rounded-full flex items-center justify-center text-white text-xs font-semibold"
                             style="width: ${a.percentage}%; background-color: ${a.color};">
                            ${a.percentage.toFixed(1)}%
                        </div>
                    </div>
                </td>
            </tr>
        `).join('');

        document.getElementById('modalContent').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-600 text-white rounded-lg p-4 text-center">
                    <p class="text-sm mb-1">Total Alegători</p>
                    <h3 class="text-3xl font-bold">${data.totalVoters.toLocaleString('ro-RO')}</h3>
                </div>
                <div class="bg-green-600 text-white rounded-lg p-4 text-center">
                    <p class="text-sm mb-1">Au Votat</p>
                    <h3 class="text-3xl font-bold">${data.votedCount.toLocaleString('ro-RO')}</h3>
                </div>
                <div class="bg-cyan-600 text-white rounded-lg p-4 text-center">
                    <p class="text-sm mb-1">Prezență</p>
                    <h3 class="text-3xl font-bold">${data.votingPercentage.toFixed(2)}%</h3>
                </div>
            </div>
            <h5 class="text-lg font-bold mb-3 flex items-center">
                <i class="fas fa-venus-mars text-pink-600 mr-2"></i>
                Statistici pe Gen
            </h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                ${genderHtml}
            </div>
            <h5 class="text-lg font-bold mb-3 flex items-center">
                <i class="fas fa-users text-purple-600 mr-2"></i>
                Statistici pe Vârstă
            </h5>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Categorie</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Alegători</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Procent</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        ${ageHtml}
                    </tbody>
                </table>
            </div>
            <p class="text-sm text-gray-500 mt-4">
                <i class="fas fa-clock mr-1"></i>
                Ultima actualizare: ${new Date(data.lastUpdated).toLocaleString('ro-RO')}
            </p>
        `;
    }
</script>